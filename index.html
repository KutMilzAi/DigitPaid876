<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KUT DIGITS AI - OMEGA TERMINAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #060914;
            --card-bg: #0f172a;
            --accent: #3b82f6;
            --success: #10b981;
            --error: #f43f5e;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: #1e293b;
            --omega: #f472b6;
            --poof: #8b5cf6;
        }

        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text-main); font-size: 12px; }

        header {
            padding: 0.75rem 1.25rem;
            background: #0f172a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand { font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #475569; transition: all 0.3s; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        .container { display: grid; grid-template-columns: 280px 1fr 280px; height: calc(100vh - 50px); overflow: hidden; }

        .sidebar { background: #0f172a; border-right: 1px solid var(--border); padding: 1rem; overflow-y: auto; }
        .control-group { margin-bottom: 0.8rem; }
        label { display: block; color: var(--text-dim); margin-bottom: 0.3rem; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        input, select { 
            width: 100%; background: #1e293b; border: 1px solid var(--border); 
            color: white; padding: 0.5rem; border-radius: 6px; font-size: 12px; outline: none;
        }
        input:focus { border-color: var(--accent); }

        .btn { 
            width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-weight: 600; 
            cursor: pointer; transition: all 0.2s; margin-bottom: 0.5rem; color: white;
        }
        .btn-primary { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-error { background: var(--error); }
        .btn-omega { background: var(--omega); }
        .btn-poof { background: var(--poof); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .main-view { padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
        
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; position: relative; }
        .card-title { font-size: 11px; font-weight: 700; color: var(--text-dim); margin-bottom: 0.75rem; display: flex; justify-content: space-between; text-transform: uppercase; }

        .digit-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .digit-box { 
            background: #1e293b; height: 50px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; border-radius: 6px; position: relative; overflow: hidden;
            transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer;
        }
        .digit-box:hover { border-color: var(--accent); background: #2d3748; }
        .digit-val { font-size: 14px; font-weight: 800; z-index: 2; pointer-events: none; }
        .digit-pct { font-size: 9px; font-weight: 600; z-index: 2; opacity: 0.8; pointer-events: none; }
        .digit-bar { position: absolute; bottom: 0; left: 0; right: 0; background: var(--accent); opacity: 0.15; transition: height 0.3s; pointer-events: none; }
        
        .digit-box.active-tick { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.4); z-index: 3; }
        .digit-box.win-highlight { 
            border: 2px solid var(--success) !important; 
            box-shadow: 0 0 15px var(--success); 
            animation: pulse-win 1.5s infinite;
            z-index: 4;
        }

        @keyframes pulse-win {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .activity-log { background: #020617; border: 1px solid var(--border); height: 140px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 0.6rem; overflow-y: auto; }
        .log-entry { margin-bottom: 4px; display: flex; gap: 8px; border-bottom: 1px solid #1e293b33; padding-bottom: 2px; }

        .ai-panel { background: #0f172a; border-left: 1px solid var(--border); padding: 1rem; overflow-y: auto; }
        .ai-stat { background: #1e293b; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.5rem; }
        .stat-val { font-size: 16px; font-weight: 700; display: block; }
        .stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; }

        .tx-card { background: #020617; border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-top: 5px; font-size: 11px; }
        .tx-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dotted #1e293b; padding-bottom: 2px; }
        .tx-label { color: var(--text-dim); }

        .indicator-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-top: 5px; }
        .ind-box { background: #0f172a; padding: 5px; border-radius: 4px; border: 1px solid #1e293b; text-align: center; }
        .ind-val { font-size: 10px; font-weight: 700; display: block; }
        .ind-lbl { font-size: 7px; color: var(--text-dim); text-transform: uppercase; }

        .poof-ui { background: #2e1065; border: 1px solid var(--poof); border-radius: 8px; padding: 0.6rem; margin-top: 5px; }
        .poof-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .poof-title { font-size: 9px; font-weight: 800; color: #ddd6fe; text-transform: uppercase; letter-spacing: 1px; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; }
        .badge-omega { background: var(--omega); color: #000; }

        @media (max-width: 1000px) {
            .container { grid-template-columns: 1fr; height: auto; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <div id="connectionStatus" class="status-dot"></div>
        KUT DIGITS <span style="color:var(--omega)">OMEGA</span>
    </div>
    <div id="balanceDisplay" style="font-weight: 700; font-size: 14px; color: var(--success);">$0.00</div>
</header>

<div class="container">
    <div class="sidebar">
        <div class="control-group">
            <label>DERIV API TOKEN</label>
            <input type="password" id="apiToken" placeholder="Token...">
        </div>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;" class="control-group">
            <div>
                <label>MARKET</label>
                <select id="market">
                    <option value="R_10">Volatility 10</option>
                    <option value="R_25">Volatility 25</option>
                    <option value="R_50">Volatility 50</option>
                    <option value="R_75">Volatility 75</option>
                    <option value="R_100" selected>Volatility 100</option>
                    <option value="1HZ10V">Vol 10 (1s)</option>
                    <option value="1HZ100V">Vol 100 (1s)</option>
                </select>
            </div>
            <div>
                <label>BARRIER</label>
                <select id="barrier">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4" selected>4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>
        </div>
        <div class="control-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label>STAKE ($)</label>
                <input type="number" id="stake" value="0.35" step="0.01">
            </div>
            <div>
                <label>DURATION (T)</label>
                <input type="number" id="duration" value="1" min="1" max="10">
            </div>
        </div>

        <button id="connectBtn" class="btn btn-primary">CONNECT ACCOUNT</button>
        <hr style="border:0; border-top:1px solid var(--border); margin: 0.8rem 0;">
        <div class="control-group">
            <label>AI MODE</label>
            <select id="aiMode">
                <option value="balanced">Neural Balanced</option>
                <option value="conservative">Safe Predictor</option>
                <option value="aggressive">High Frequency</option>
                <option value="adaptive" selected>Fully Adaptive (Omega)</option>
            </select>
        </div>
        <button id="buyOver" class="btn btn-success" disabled>BUY OVER</button>
        <button id="buyUnder" class="btn btn-error" disabled>BUY UNDER</button>
        <button id="aiBtn" class="btn btn-omega" disabled>START AI ENGINE</button>
        
        <div class="poof-ui">
            <div class="poof-header">
                <span class="poof-title">Poof Sub-Engine</span>
                <span id="poofValue" style="color: var(--poof); font-weight: 900;">0.0%</span>
            </div>
            <div id="poofPrediction" style="font-size: 10px; color: #a5b4fc; font-style: italic;">Calibrating (W:20)...</div>
        </div>
    </div>

    <div class="main-view">
        <div class="card">
            <div class="card-title">DIGIT FREQUENCY (100) <span style="font-size: 8px; color: var(--accent);">CLICK TO SET BARRIER</span></div>
            <div class="digit-grid" id="digitFrequency"></div>
        </div>

        <div class="card">
            <div class="card-title">LIVE OMEGA FEED <span id="active-ai-mode-label" class="badge badge-omega">Neural</span></div>
            <div id="log" class="activity-log"></div>
        </div>

        <div class="card" style="flex: 1; min-height: 160px;">
            <div class="card-title">PREDICTION ACCURACY</div>
            <div style="flex:1; position:relative;"><canvas id="accuracyChart"></canvas></div>
        </div>
    </div>

    <div class="ai-panel">
        <div class="ai-stat">
            <span class="stat-label">Omega AI Confidence</span>
            <span id="aiConfidence" class="stat-val" style="color:var(--omega)">0.0%</span>
        </div>
        <div class="ai-stat">
            <span class="stat-label">AI Recommendation</span>
            <span id="recBarrier" class="stat-val">--</span>
        </div>
        <div class="ai-stat">
            <span class="stat-label">Session Profit</span>
            <span id="sessionProfit" class="stat-val">$0.00</span>
        </div>
        
        <label>Live Transaction</label>
        <div class="tx-card" id="txDisplay">
            <div class="tx-row"><span class="tx-label">Status:</span> <span id="txStatus">Idle</span></div>
            <div class="tx-row"><span class="tx-label">Entry Spot:</span> <span id="txEntry">-</span></div>
            <div class="tx-row"><span class="tx-label">Tick:</span> <span id="txTick">-</span></div>
            <div class="tx-row"><span class="tx-label">Time:</span> <span id="txTime">-</span></div>
            <div class="tx-row"><span class="tx-label">Result:</span> <span id="txResult">-</span></div>
        </div>

        <div class="card" style="margin-top: 1rem; padding: 0.5rem; background: #1e1b4b; border: 1px solid #312e81;">
            <div class="card-title" style="color: #c4b5fd; margin-bottom: 5px;">OMEGA INSIGHT</div>
            <p id="aiInsight" style="font-size: 10px; line-height: 1.4; color: #a5b4fc; margin: 0; min-height: 28px;">Waiting for connection...</p>
            
            <div class="indicator-grid">
                <div class="ind-box">
                    <span id="rsiVal" class="ind-val">--</span>
                    <span class="ind-lbl">RSI (Digit)</span>
                </div>
                <div class="ind-box">
                    <span id="volVal" class="ind-val">--</span>
                    <span class="ind-lbl">Volatility</span>
                </div>
                <div class="ind-box">
                    <span id="trendVal" class="ind-val">--</span>
                    <span class="ind-lbl">Trend</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let ws;
let ticks = [];
let stats = Array(10).fill(0);
let winCount = 0, totalTrades = 0, sessionProfit = 0;
let isAiRunning = false, isTradeActive = false; 
let accuracyChart;
let txResetTimer = null;
let smoothedConf = 0;
let poofConf = 0;

// Initialize Digit Grid UI
const digitFreqContainer = document.getElementById('digitFrequency');
for(let i=0; i<=9; i++) {
    const div = document.createElement('div');
    div.className = 'digit-box';
    div.id = `digit-${i}`;
    div.dataset.digit = i;
    div.innerHTML = `<span class="digit-val">${i}</span><span class="digit-pct" id="pct-${i}">0%</span><div class="digit-bar" id="bar-${i}"></div>`;
    div.addEventListener('click', () => {
        document.getElementById('barrier').value = parseInt(div.dataset.digit);
        addLog(`Barrier Lock: ${div.dataset.digit}`, 'success');
        div.style.background = 'var(--accent)';
        setTimeout(() => div.style.background = '', 200);
        runAIAnalysis();
    });
    digitFreqContainer.appendChild(div);
}

function safeSend(data) {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data));
    }
}

function initCharts() {
    if (accuracyChart) accuracyChart.destroy();
    const ctx = document.getElementById('accuracyChart').getContext('2d');
    accuracyChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#f472b6', borderWidth: 2, tension: 0.4, pointRadius: 2, fill: true, backgroundColor: 'rgba(244, 114, 182, 0.1)' }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8', font: { size: 9 } } }, x: { display: false } }, plugins: { legend: { display: false } } }
    });
}

function addLog(msg, type = 'info') {
    const log = document.getElementById('log');
    const entry = document.createElement('div');
    entry.className = `log-entry`;
    const color = type === 'success' ? '#10b981' : type === 'error' ? '#f43f5e' : type === 'warning' ? '#f59e0b' : '#3b82f6';
    entry.style.color = color;
    entry.innerHTML = `<span>[${new Date().toLocaleTimeString([], {hour12:false})}]</span> <span>${msg}</span>`;
    log.prepend(entry);
    if(log.childNodes.length > 50) log.lastChild.remove();
}

function resetTxUI() {
    document.getElementById('txStatus').innerText = "Idle";
    document.getElementById('txEntry').innerText = "-";
    document.getElementById('txTick').innerText = "-";
    document.getElementById('txTime').innerText = "-";
    document.getElementById('txResult').innerText = "-";
    document.getElementById('txResult').style.color = 'var(--text-main)';
}

function updateTxUI(data) {
    if (txResetTimer) clearTimeout(txResetTimer);
    if (data.status) document.getElementById('txStatus').innerText = data.status;
    if (data.entry) document.getElementById('txEntry').innerText = data.entry;
    if (data.tick) document.getElementById('txTick').innerText = data.tick;
    if (data.time) document.getElementById('txTime').innerText = data.time;
    if (data.result !== undefined) {
        const el = document.getElementById('txResult');
        el.innerText = data.result;
        el.style.color = data.result.includes('WIN') ? 'var(--success)' : 'var(--error)';
        if(data.result.includes('WIN')) {
            const lastD = parseInt(document.getElementById('txTick').innerText.slice(-1));
            document.querySelectorAll('.digit-box').forEach(b => b.classList.remove('win-highlight'));
            document.getElementById(`digit-${lastD}`)?.classList.add('win-highlight');
        }
        txResetTimer = setTimeout(resetTxUI, 5000);
    }
}

function toggleConnection() {
    const btn = document.getElementById('connectBtn');
    if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) { 
        ws.close(); 
        return; 
    }
    
    const token = document.getElementById('apiToken').value.trim();
    if(!token) return addLog("API Token required", "error");
    
    addLog("Connecting to server...", "warning");
    ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
    
    ws.onopen = () => {
        safeSend({ authorize: token });
    };
    
    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if(data.error) {
            addLog(data.error.message, "error");
            if (data.error.code === 'AuthorizationRequired') ws.close();
            return;
        }
        
        if(data.msg_type === 'authorize') {
            document.getElementById('connectionStatus').classList.add('online');
            btn.innerText = "DISCONNECT";
            btn.classList.replace('btn-primary', 'btn-error');
            
            // Subscriptions
            safeSend({ ticks: document.getElementById('market').value, subscribe: 1 });
            safeSend({ balance: 1, subscribe: 1 });
            safeSend({ proposal_open_contract: 1, subscribe: 1 });
            
            initCharts();
            document.querySelectorAll('.sidebar .btn').forEach(b => b.disabled = false);
            addLog("Authorization Successful", "success");
            document.getElementById('aiInsight').innerText = "Streaming Market Data...";
        }
        
        if(data.msg_type === 'balance') document.getElementById('balanceDisplay').innerText = `${data.balance.currency} ${data.balance.balance}`;
        if(data.msg_type === 'tick') processTick(data.tick);
        if(data.msg_type === 'buy') { 
            isTradeActive = true; 
            updateTxUI({ status: "Trade Active", time: new Date().toLocaleTimeString() }); 
        }
        if(data.msg_type === 'proposal_open_contract') {
            const c = data.proposal_open_contract;
            if(!c) return;
            updateTxUI({ entry: c.entry_tick_display_value, tick: c.exit_tick_display_value || "..." });
            if(c.is_sold) {
                isTradeActive = false;
                const p = parseFloat(c.profit);
                sessionProfit += p; totalTrades++;
                if(p > 0) winCount++;
                updateTxUI({ status: "Closed", result: p > 0 ? `WIN +$${p.toFixed(2)}` : `LOSS $${p.toFixed(2)}` });
                updateAccountUI();
            }
        }
    };
    
    ws.onclose = () => {
        document.getElementById('connectionStatus').classList.remove('online');
        btn.innerText = "CONNECT ACCOUNT";
        btn.classList.replace('btn-error', 'btn-primary');
        document.querySelectorAll('.sidebar .btn:not(#connectBtn)').forEach(b => b.disabled = true);
        isAiRunning = false;
        document.getElementById('aiInsight').innerText = "Disconnected.";
        addLog("Server Disconnected", "info");
    };
}

document.getElementById('connectBtn').onclick = toggleConnection;

function processTick(tick) {
    if (!tick || !tick.quote) return;
    const quoteStr = tick.quote.toString();
    const digit = parseInt(quoteStr.slice(-1));
    
    ticks.push(digit);
    if(ticks.length > 100) ticks.shift();

    // Visual feedback for the latest digit
    document.querySelectorAll('.digit-box').forEach(b => b.classList.remove('active-tick'));
    const box = document.getElementById(`digit-${digit}`);
    if (box) box.classList.add('active-tick');

    // Frequency update
    stats = Array(10).fill(0);
    ticks.forEach(d => stats[d]++);
    for(let i=0; i<=9; i++) {
        const pct = (stats[i] / ticks.length) * 100;
        const bar = document.getElementById(`bar-${i}`);
        const text = document.getElementById(`pct-${i}`);
        if (bar) bar.style.height = `${pct}%`;
        if (text) text.innerText = `${pct.toFixed(0)}%`;
    }
    
    runAIAnalysis();
}

function calculateRSI(data, period = 14) {
    if(data.length <= period) return 50;
    let gains = 0, losses = 0;
    for(let i = 1; i <= period; i++) {
        let diff = data[data.length - i] - data[data.length - i - 1];
        if(diff >= 0) gains += diff; else losses -= diff;
    }
    return losses === 0 ? 100 : 100 - (100 / (1 + (gains / (losses || 1))));
}

function runAIAnalysis() {
    if(ticks.length < 5) return; // Wait for at least some data
    const userBarrier = parseInt(document.getElementById('barrier').value);
    
    // Indicators
    const rsi = calculateRSI(ticks, 14);
    const recent = ticks.slice(-15);
    const mean = recent.reduce((a, b) => a + b, 0) / recent.length;
    const volatility = Math.sqrt(recent.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / recent.length);
    const trend = (ticks.slice(-10).reduce((a,b)=>a+b, 0)/10) > (ticks.slice(-30).reduce((a,b)=>a+b, 0)/30) ? "BULL" : "BEAR";

    document.getElementById('rsiVal').innerText = rsi.toFixed(1);
    document.getElementById('volVal').innerText = volatility.toFixed(2);
    document.getElementById('trendVal').innerText = trend;
    document.getElementById('trendVal').style.color = trend === "BULL" ? 'var(--success)' : 'var(--error)';

    // AI AUTO-DURATION (ADAPTIVE)
    const autoDuration = volatility > 2.5 ? 1 : volatility > 1.5 ? 2 : 3;
    document.getElementById('duration').value = autoDuration;

    // POOF SUB-ENGINE (Window: 20)
    const poofTicks = ticks.slice(-20);
    const pOver = poofTicks.filter(d => d > userBarrier).length;
    const pUnder = poofTicks.filter(d => d < userBarrier).length;
    const pDir = pOver > pUnder ? "OVER" : "UNDER";
    poofConf = Math.max(pOver, pUnder) / (poofTicks.length || 1) * 100;
    document.getElementById('poofValue').innerText = `${poofConf.toFixed(1)}%`;
    document.getElementById('poofPrediction').innerText = `Poof: ${pDir} ${userBarrier}`;

    // MAIN OMEGA AI
    const overCount = ticks.slice(-25).filter(d => d > userBarrier).length;
    const underCount = ticks.slice(-25).filter(d => d < userBarrier).length;
    let targetDir = overCount > underCount ? "over" : "under";
    let baseConfidence = (Math.max(overCount, underCount) / 25) * 100;
    
    // Logic Boosters
    if (targetDir === "over" && trend === "BULL") baseConfidence += 5;
    if (targetDir === "under" && trend === "BEAR") baseConfidence += 5;
    
    smoothedConf = (smoothedConf * 0.5) + (baseConfidence * 0.5);
    document.getElementById('aiConfidence').innerText = `${smoothedConf.toFixed(1)}%`;
    
    document.getElementById('recBarrier').innerText = `${targetDir.toUpperCase()} ${userBarrier}`;
    document.getElementById('aiInsight').innerText = smoothedConf > 80 ? `SIGNAL STRENGTH HIGH` : "Waiting for pattern overlap...";
}

function updateAccountUI() {
    document.getElementById('sessionProfit').innerText = `$${sessionProfit.toFixed(2)}`;
    document.getElementById('sessionProfit').style.color = sessionProfit >= 0 ? 'var(--success)' : 'var(--error)';
    if(accuracyChart) {
        accuracyChart.data.labels.push("");
        accuracyChart.data.datasets[0].data.push(totalTrades > 0 ? (winCount/totalTrades)*100 : 0);
        if(accuracyChart.data.labels.length > 25) { accuracyChart.data.labels.shift(); accuracyChart.data.datasets[0].data.shift(); }
        accuracyChart.update('none');
    }
}

async function executeTrade(direction) {
    if(!ws || ws.readyState !== WebSocket.OPEN || isTradeActive) return;
    const stake = parseFloat(document.getElementById('stake').value);
    const barrier = document.getElementById('barrier').value;
    const duration = parseInt(document.getElementById('duration').value);
    
    safeSend({
        buy: 1, price: stake,
        parameters: { 
            amount: stake, basis: 'stake', 
            contract_type: direction === 'over' ? 'DIGITOVER' : 'DIGITUNDER', 
            currency: 'USD', duration: duration, duration_unit: 't', 
            symbol: document.getElementById('market').value, barrier: barrier.toString()
        }
    });
    addLog(`Sent ${direction.toUpperCase()} @ ${barrier} (${duration}T)`, "info");
}

document.getElementById('buyOver').onclick = () => executeTrade('over');
document.getElementById('buyUnder').onclick = () => executeTrade('under');

document.getElementById('aiBtn').onclick = () => {
    isAiRunning = !isAiRunning;
    const btn = document.getElementById('aiBtn');
    if(isAiRunning) {
        btn.innerText = "STOP AI ENGINE";
        btn.classList.replace('btn-omega', 'btn-error');
        addLog("AI Engine Started", "warning");
        autoLoop();
    } else {
        btn.innerText = "START AI ENGINE";
        btn.classList.replace('btn-error', 'btn-omega');
        addLog("AI Engine Stopped", "info");
    }
};

async function autoLoop() {
    if(!isAiRunning) return;
    const conf = smoothedConf;
    const pConf = poofConf;
    const rsi = parseFloat(document.getElementById('rsiVal').innerText);
    const trend = document.getElementById('trendVal').innerText;
    const userBarrier = document.getElementById('barrier').value;
    const recText = document.getElementById('recBarrier').innerText;
    
    // Optimized Entry Condition: Omega (Window 100) + Poof (Window 20) Agreement
    if(conf >= 85 && pConf >= 70 && !isTradeActive) {
        const dir = recText.includes("OVER") ? "over" : "under";
        
        // Safety trend filter
        let trendSafe = (dir === 'over' && trend === 'BULL') || (dir === 'under' && trend === 'BEAR');

        if(trendSafe) {
            executeTrade(dir);
            await new Promise(r => setTimeout(r, 6000)); // Delay after trade
        }
    }
    await new Promise(r => setTimeout(r, 400));
    if(isAiRunning) autoLoop();
}
</script>
</body>
</html>
