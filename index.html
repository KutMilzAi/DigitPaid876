<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KUT DIGITS AI - OMEGA TERMINAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #060914;
            --card-bg: #0f172a;
            --accent: #3b82f6;
            --success: #10b981;
            --error: #f43f5e;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: #1e293b;
            --omega: #f472b6;
            --poof: #8b5cf6;
        }

        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text-main); font-size: 12px; overflow: hidden; }

        header {
            padding: 0.75rem 1.25rem;
            background: #0f172a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            height: 50px;
        }

        .brand { font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #475569; transition: all 0.3s; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        .container { display: grid; grid-template-columns: 280px 1fr 280px; height: calc(100vh - 50px); overflow: hidden; }

        .sidebar { background: #0f172a; border-right: 1px solid var(--border); padding: 1rem; overflow-y: auto; width: 280px; }
        .control-group { margin-bottom: 0.8rem; }
        label { display: block; color: var(--text-dim); margin-bottom: 0.3rem; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        input, select { 
            width: 100%; background: #1e293b; border: 1px solid var(--border); 
            color: white; padding: 0.5rem; border-radius: 6px; font-size: 12px; outline: none;
        }
        input:focus { border-color: var(--accent); }

        .btn { 
            width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-weight: 600; 
            cursor: pointer; transition: all 0.2s; margin-bottom: 0.5rem; color: white;
        }
        .btn-primary { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-error { background: var(--error); }
        .btn-omega { background: var(--omega); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .main-view { padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
        
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; position: relative; flex-shrink: 0; }
        .card-title { font-size: 11px; font-weight: 700; color: var(--text-dim); margin-bottom: 0.75rem; display: flex; justify-content: space-between; text-transform: uppercase; align-items: center; }

        .freq-card { height: 180px; }
        .feed-card { height: 220px; }
        .accuracy-card { height: 200px; flex-grow: 0; }
        
        .module-card { height: 130px; flex-shrink: 0; }
        .module-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px dashed #1e293b; border-radius: 8px; background: #020617; transition: all 0.3s ease; }
        .module-val { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 800; color: #f8fafc; }
        .module-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-top: 5px; }

        .digit-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .digit-box { 
            background: #1e293b; height: 50px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; border-radius: 6px; position: relative; overflow: hidden;
            transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer;
        }
        .digit-box:hover { border-color: var(--accent); background: #2d3748; }
        .digit-val { font-size: 14px; font-weight: 800; z-index: 2; pointer-events: none; }
        .digit-pct { font-size: 9px; font-weight: 600; z-index: 2; opacity: 0.8; pointer-events: none; }
        .digit-bar { position: absolute; bottom: 0; left: 0; right: 0; background: var(--accent); opacity: 0.15; transition: height 0.3s; pointer-events: none; }
        
        .digit-box.active-tick { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.4); z-index: 3; }

        .activity-log { background: #020617; border: 1px solid var(--border); height: 160px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 0.6rem; overflow-y: auto; }
        .log-entry { margin-bottom: 4px; display: flex; gap: 8px; border-bottom: 1px solid #1e293b33; padding-bottom: 2px; }

        .ai-panel { background: #0f172a; border-left: 1px solid var(--border); padding: 1rem; overflow-y: auto; width: 280px; display: flex; flex-direction: column; }
        .ai-stat { background: #1e293b; padding: 0.6rem; border-radius: 8px; margin-bottom: 0.5rem; height: 55px; flex-shrink: 0; }
        .stat-val { font-size: 16px; font-weight: 700; display: block; }
        .stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; }

        .tx-card { background: #020617; border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-top: 5px; font-size: 11px; height: 115px; flex-shrink: 0; }
        .tx-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dotted #1e293b; padding-bottom: 2px; }
        .tx-label { color: var(--text-dim); }

        .history-card { background: #020617; border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; margin-top: 1rem; flex-grow: 1; min-height: 150px; display: flex; flex-direction: column; overflow: hidden; }
        .history-list { overflow-y: auto; flex-grow: 1; font-family: 'JetBrains Mono', monospace; font-size: 10px; }
        
        .history-item { 
            background: #0f172a; margin-bottom: 6px; padding: 8px; border-radius: 6px; border-left: 3px solid #334155; display: flex; flex-direction: column; gap: 4px;
        }
        .history-item.win { border-left-color: var(--success); }
        .history-item.loss { border-left-color: var(--error); }
        .hist-header { display: flex; justify-content: space-between; font-weight: 800; font-size: 11px; }

        .btn-clear { background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 2px 6px; font-size: 9px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .btn-clear:hover { background: var(--error); color: white; border-color: var(--error); }

        .indicator-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-top: 5px; }
        .ind-box { background: #0f172a; padding: 5px; border-radius: 4px; border: 1px solid #1e293b; text-align: center; }
        .ind-val { font-size: 10px; font-weight: 700; display: block; }
        .ind-lbl { font-size: 7px; color: var(--text-dim); text-transform: uppercase; }

        .poof-ui { background: #2e1065; border: 1px solid var(--poof); border-radius: 8px; padding: 0.6rem; margin-top: 5px; height: 65px; }
        .poof-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .poof-title { font-size: 9px; font-weight: 800; color: #ddd6fe; text-transform: uppercase; letter-spacing: 1px; }

        .boost-bar { width: 100%; height: 4px; background: #312e81; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .boost-fill { height: 100%; width: 0%; background: var(--omega); transition: width 0.3s ease; }

        /* MODAL CSS */
        #digitModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--card-bg); border: 1px solid var(--accent);
            padding: 1.5rem; border-radius: 12px; width: 280px; text-align: center;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
        }
        .modal-title { font-size: 14px; font-weight: 800; margin-bottom: 1rem; color: var(--text-main); text-transform: uppercase; }
        .modal-actions { display: flex; flex-direction: column; gap: 8px; }
        .modal-btn { padding: 12px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; color: white; transition: transform 0.1s, opacity 0.2s; }
        .modal-btn:active { transform: scale(0.95); }
        .modal-btn:hover { opacity: 0.9; }
        .m-over { background: var(--success); }
        .m-under { background: var(--error); }
        .m-bulk { background: var(--omega); }
        .m-barrier { background: var(--accent); }
        .m-close { background: transparent; border: 1px solid var(--border); color: var(--text-dim); margin-top: 5px; font-size: 10px; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <div id="connectionStatus" class="status-dot"></div>
        KUT DIGITS <span style="color:var(--omega)">OMEGA</span>
    </div>
    <div id="balanceDisplay" style="font-weight: 700; font-size: 14px; color: var(--success);">$0.00</div>
</header>

<!-- INTERACTIVE MODAL -->
<div id="digitModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">ACTION FOR DIGIT 0</div>
        <div class="modal-actions">
            <button class="modal-btn m-over" id="modalBuyOver">TRADE OVER</button>
            <button class="modal-btn m-under" id="modalBuyUnder">TRADE UNDER</button>
            <button class="modal-btn m-bulk" id="modalBulkX">BULK X (OMEGA)</button>
            <button class="modal-btn m-barrier" id="modalSetBarrier">SET AS BARRIER</button>
            <button class="modal-btn m-close" onclick="closeDigitModal()">CANCEL</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="control-group">
            <label>DERIV API TOKEN</label>
            <input type="password" id="apiToken" placeholder="Enter Deriv Token...">
        </div>
        <div class="control-group">
            <label>BOT ACCESS KEY</label>
            <input type="password" id="botPassword" placeholder="Enter 3-digit key...">
        </div>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;" class="control-group">
            <div>
                <label>MARKET</label>
                <select id="market">
                    <option value="R_100" selected>Volatility 100</option>
                    <option value="1HZ100V">Volatility 100 (1s)</option>
                    <option value="R_10">Volatility 10</option>
                    <option value="R_25">Volatility 25</option>
                    <option value="R_50">Volatility 50</option>
                    <option value="R_75">Volatility 75</option>
                    <option value="1HZ10V">Volatility 10 (1s)</option>
                    <option value="JD10">Jump 10 Index</option>
                    <option value="JD100">Jump 100 Index</option>
                </select>
            </div>
            <div>
                <label>BARRIER</label>
                <select id="barrier">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4" selected>4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>
        </div>
        <div class="control-group" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
            <div>
                <label>STAKE ($)</label>
                <input type="number" id="stake" value="0.35" step="0.01">
            </div>
            <div>
                <label>DUR (T)</label>
                <input type="number" id="duration" value="1" min="1" max="10">
            </div>
            <div>
                <label>BULK (X)</label>
                <input type="number" id="bulk" value="1" min="1" max="10">
            </div>
        </div>

        <button id="connectBtn" class="btn btn-primary">CONNECT ACCOUNT</button>
        <hr style="border:0; border-top:1px solid var(--border); margin: 0.8rem 0;">
        <div class="control-group">
            <label>AI MODE</label>
            <select id="aiMode">
                <option value="adaptive" selected>Fully Adaptive (Omega)</option>
                <option value="aggressive">Omega Aggressive (Fast)</option>
                <option value="conservative">Safe Predictor (90%+)</option>
            </select>
        </div>
        <button id="buyOver" class="btn btn-success" disabled>BUY OVER</button>
        <button id="buyUnder" class="btn btn-error" disabled>BUY UNDER</button>
        <button id="aiBtn" class="btn btn-omega" disabled>START AI ENGINE</button>
        
        <div class="poof-ui">
            <div class="poof-header">
                <span class="poof-title">Poof Sub-Engine</span>
                <span id="poofValue" style="color: var(--poof); font-weight: 900;">0.0%</span>
            </div>
            <div id="poofPrediction" style="font-size: 10px; color: #a5b4fc; font-style: italic;">Calibrating (W:25)...</div>
        </div>
    </div>

    <div class="main-view">
        <div class="card freq-card">
            <div class="card-title">DIGIT FREQUENCY (100)</div>
            <div class="digit-grid" id="digitFrequency"></div>
        </div>

        <div class="card feed-card">
            <div class="card-title">LIVE OMEGA FEED</div>
            <div id="log" class="activity-log"></div>
        </div>

        <div class="card accuracy-card">
            <div class="card-title">PREDICTION ACCURACY</div>
            <div id="accuracyChartContainer" style="height: 100%;">
                <canvas id="accuracyChart"></canvas>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-title">OMEGA GRAVITY [1]</div>
            <div class="module-content" id="core1Box">
                <div class="module-val" id="core1Val">--</div>
                <div class="module-label" id="core1Label">Analyzing Pull...</div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-title">VELOCITY BOOST [2]</div>
            <div class="module-content" id="core2Box">
                <div class="module-val" id="core2Val">--</div>
                <div class="module-label" id="core2Label">Calculating Speed...</div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-title">PATTERN SYNC [3]</div>
            <div class="module-content" id="core3Box">
                <div class="module-val" id="core3Val">--</div>
                <div class="module-label" id="core3Label">Cross-Checking</div>
            </div>
        </div>

        <div class="card module-card">
            <div class="card-title">VOLATILITY FLOOR [4]</div>
            <div class="module-content" id="core4Box">
                <div class="module-val" id="core4Val">--</div>
                <div class="module-label" id="core4Label">Market Noise</div>
            </div>
        </div>
    </div>

    <div class="ai-panel">
        <div class="ai-stat">
            <span class="stat-label">Omega AI Confidence</span>
            <span id="aiConfidence" class="stat-val" style="color:var(--omega)">0.0%</span>
            <div class="boost-bar"><div id="boostFill" class="boost-fill"></div></div>
        </div>
        <div class="ai-stat">
            <span class="stat-label">AI Status</span>
            <span id="aiStatusDisplay" class="stat-val" style="color:var(--success); font-size: 13px;">AI STANDBY</span>
        </div>
        <div class="ai-stat">
            <span class="stat-label">Session Profit</span>
            <span id="sessionProfit" class="stat-val">$0.00</span>
        </div>
        
        <label>Live Transaction</label>
        <div class="tx-card" id="txDisplay">
            <div class="tx-row"><span class="tx-label">Status:</span> <span id="txStatus">Idle</span></div>
            <div class="tx-row"><span class="tx-label">Entry Spot:</span> <span id="txEntry">-</span></div>
            <div class="tx-row"><span class="tx-label">Last Tick:</span> <span id="txTick">-</span></div>
            <div class="tx-row"><span class="tx-label">Time:</span> <span id="txTime">-</span></div>
            <div class="tx-row"><span class="tx-label">Result:</span> <span id="txResult">-</span></div>
        </div>

        <div class="card" style="margin-top: 1rem; padding: 0.5rem; background: #1e1b4b; border: 1px solid #312e81; height: 110px; flex-shrink: 0;">
            <div class="card-title" style="color: #c4b5fd; margin-bottom: 5px;">OMEGA INSIGHT</div>
            <p id="aiInsight" style="font-size: 10px; line-height: 1.4; color: #a5b4fc; margin: 0;">Waiting for connection...</p>
            <div class="indicator-grid">
                <div class="ind-box"><span id="rsiVal" class="ind-val">--</span><span class="ind-lbl">RSI</span></div>
                <div class="ind-box"><span id="volVal" class="ind-val">--</span><span class="ind-lbl">Volat</span></div>
                <div class="ind-box"><span id="trendVal" class="ind-val">--</span><span class="ind-lbl">Trend</span></div>
            </div>
        </div>

        <div class="history-card">
            <div class="card-title">TX HISTORY <button class="btn-clear" id="clearHistory">CLEAR</button></div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>
</div>

<script>
let ws;
let ticks = [];
let winCount = 0, totalTrades = 0, sessionProfit = 0;
let isAiRunning = false, isTradeActive = false; 
let accuracyChart;
let smoothedConf = 0;
let poofConf = 0;
let tickCounter = 0;
let lastTradeTick = -10;
let lastTickTime = Date.now();
let selectedDigit = 0;

// MODAL LOGIC
function openDigitModal(digit) {
    selectedDigit = digit;
    document.getElementById('modalTitle').innerText = `ACTION FOR DIGIT ${digit}`;
    document.getElementById('digitModal').style.display = 'flex';
}

function closeDigitModal() {
    document.getElementById('digitModal').style.display = 'none';
}

document.getElementById('modalBuyOver').onclick = () => {
    if (!document.getElementById('buyOver').disabled) {
        executeTradeSpecific('over', selectedDigit);
        closeDigitModal();
    } else {
        addLog("Please connect account first", "error");
    }
};

document.getElementById('modalBuyUnder').onclick = () => {
    if (!document.getElementById('buyUnder').disabled) {
        executeTradeSpecific('under', selectedDigit);
        closeDigitModal();
    } else {
        addLog("Please connect account first", "error");
    }
};

document.getElementById('modalBulkX').onclick = async () => {
    if (document.getElementById('buyOver').disabled) {
        addLog("Please connect account first", "error");
        return;
    }
    const bulk = parseInt(document.getElementById('bulk').value) || 1;
    // Determine direction based on Poof sub-engine prediction for this digit
    const dir = document.getElementById('poofPrediction').innerText.includes("OVER") ? "over" : "under";
    
    addLog(`Executing Bulk ${bulk}x on Digit ${selectedDigit}...`, "warning");
    // Fire trades immediately with 200ms spacing to stack them on the platform
    for(let i=0; i<bulk; i++) {
        executeTradeSpecific(dir, selectedDigit);
        await new Promise(r => setTimeout(r, 200));
    }
    closeDigitModal();
};

document.getElementById('modalSetBarrier').onclick = () => {
    document.getElementById('barrier').value = selectedDigit;
    addLog(`Barrier Switch: ${selectedDigit}`, "success");
    closeDigitModal();
};

// INITIALIZE DIGIT GRID
const digitFreqContainer = document.getElementById('digitFrequency');
for(let i=0; i<=9; i++) {
    const div = document.createElement('div');
    div.className = 'digit-box';
    div.id = `digit-${i}`;
    div.innerHTML = `<span class="digit-val">${i}</span><span class="digit-pct" id="pct-${i}">0%</span><div class="digit-bar" id="bar-${i}"></div>`;
    div.onclick = () => openDigitModal(i);
    digitFreqContainer.appendChild(div);
}

function safeSend(data) { if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(data)); }

function initCharts() {
    if (accuracyChart) accuracyChart.destroy();
    const ctx = document.getElementById('accuracyChart').getContext('2d');
    accuracyChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#f472b6', borderWidth: 2, tension: 0.4, pointRadius: 2, fill: true, backgroundColor: 'rgba(244, 114, 182, 0.1)' }] },
        options: { 
            responsive: true, maintainAspectRatio: false, 
            animation: { duration: 0 },
            scales: { y: { min: 0, max: 100, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8', font: { size: 9 } } }, x: { display: false } }, 
            plugins: { legend: { display: false } } 
        }
    });
}

function addLog(msg, type = 'info') {
    const log = document.getElementById('log');
    const entry = document.createElement('div');
    entry.className = `log-entry`;
    const color = type === 'success' ? '#10b981' : type === 'error' ? '#f43f5e' : type === 'warning' ? '#f59e0b' : '#3b82f6';
    entry.style.color = color;
    entry.innerHTML = `<span>[${new Date().toLocaleTimeString([], {hour12:false})}]</span> <span>${msg}</span>`;
    log.prepend(entry);
    if(log.childNodes.length > 50) log.lastChild.remove();
}

function resetTxUI() {
    document.getElementById('txStatus').innerText = "Idle";
    document.getElementById('txEntry').innerText = "-";
    document.getElementById('txTick').innerText = "-";
    document.getElementById('txTime').innerText = "-";
    document.getElementById('txResult').innerText = "-";
    document.getElementById('txResult').style.color = 'var(--text-main)';
}

function resetSystemUI(fullReset = true) {
    ticks = [];
    smoothedConf = 0; 
    poofConf = 0; 
    tickCounter = 0;
    lastTradeTick = -10;
    
    if (fullReset) {
        winCount = 0; 
        totalTrades = 0; 
        sessionProfit = 0;
        isAiRunning = false;
        isTradeActive = false;
        document.getElementById('balanceDisplay').innerText = "$0.00";
        document.getElementById('sessionProfit').innerText = "$0.00";
        document.getElementById('sessionProfit').style.color = "var(--text-main)";
        if (accuracyChart) { accuracyChart.data.labels = []; accuracyChart.data.datasets[0].data = []; accuracyChart.update(); }
    }

    document.getElementById('aiConfidence').innerText = "0.0%";
    document.getElementById('boostFill').style.width = "0%";
    document.getElementById('aiStatusDisplay').innerText = "AI STANDBY";
    document.getElementById('aiStatusDisplay').style.color = "var(--text-dim)";
    document.getElementById('aiInsight').innerText = "Waiting for data...";
    document.getElementById('poofValue').innerText = "0.0%";
    document.getElementById('poofPrediction').innerText = "Calibrating (W:25)...";
    
    document.getElementById('rsiVal').innerText = "--";
    document.getElementById('volVal').innerText = "--";
    document.getElementById('trendVal').innerText = "--";
    document.getElementById('core1Val').innerText = "--";
    document.getElementById('core2Val').innerText = "--";
    document.getElementById('core3Val').innerText = "--";
    document.getElementById('core4Val').innerText = "--";

    for(let i=0; i<=9; i++) {
        document.getElementById(`bar-${i}`).style.height = `0%`;
        document.getElementById(`pct-${i}`).innerText = `0%`;
        document.getElementById(`digit-${i}`).classList.remove('active-tick');
    }

    resetTxUI();

    if (fullReset) {
        document.getElementById('aiBtn').innerText = "START AI ENGINE";
        document.getElementById('aiBtn').classList.add('btn-omega');
        document.getElementById('aiBtn').classList.remove('btn-error');
    }

    addLog("Memory Purged - Data Fresh", "warning");
}

function updateTxUI(data) {
    if (data.status) document.getElementById('txStatus').innerText = data.status;
    if (data.entry) document.getElementById('txEntry').innerText = data.entry;
    if (data.tick) document.getElementById('txTick').innerText = data.tick;
    if (data.time) document.getElementById('txTime').innerText = data.time;
    if (data.result !== undefined) {
        const el = document.getElementById('txResult');
        el.innerText = data.result;
        el.style.color = data.result.includes('WIN') ? 'var(--success)' : 'var(--error)';
    }
}

function addToHistory(contract) {
    const list = document.getElementById('historyList');
    const item = document.createElement('div');
    const profit = parseFloat(contract.profit);
    const isWin = profit > 0;
    const type = contract.contract_type.includes('OVER') ? 'OVER' : 'UNDER';
    item.className = `history-item ${isWin ? 'win' : 'loss'}`;
    item.innerHTML = `
        <div class="hist-header">
            <span style="color: ${isWin ? 'var(--success)' : 'var(--error)'}">${type} ${contract.barrier}</span>
            <span style="color: ${isWin ? 'var(--success)' : 'var(--error)'}">${isWin ? '+' : ''}${profit.toFixed(2)} USD</span>
        </div>
        <div style="font-size:9px; color:var(--text-dim)">Entry: ${contract.entry_tick_display_value} | Exit: ${contract.exit_tick_display_value}</div>
    `;
    list.prepend(item);
    if(list.childNodes.length > 20) list.lastChild.remove();
}

document.getElementById('market').onchange = (e) => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        addLog(`Switching Market: ${e.target.value}`, "warning");
        safeSend({ forget_all: "ticks" }); 
        resetSystemUI(false); 
        safeSend({ ticks: e.target.value, subscribe: 1 }); 
    }
};

document.getElementById('connectBtn').onclick = () => {
    if (ws && ws.readyState < 2) { ws.close(); return; }
    const token = document.getElementById('apiToken').value.trim();
    if(!token) return addLog("API Token required", "error");
    if(document.getElementById('botPassword').value !== "641") return addLog("Invalid Access Key", "error");

    addLog("Connecting...", "warning");
    ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
    ws.onopen = () => safeSend({ authorize: token });
    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if(data.error) return addLog(data.error.message, "error");
        if(data.msg_type === 'authorize') {
            document.getElementById('connectionStatus').classList.add('online');
            document.getElementById('connectBtn').innerText = "DISCONNECT";
            document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-error');
            safeSend({ ticks: document.getElementById('market').value, subscribe: 1 });
            safeSend({ balance: 1, subscribe: 1 });
            safeSend({ proposal_open_contract: 1, subscribe: 1 });
            initCharts();
            document.querySelectorAll('.sidebar .btn').forEach(b => b.disabled = false);
            addLog("System Online", "success");
        }
        if(data.msg_type === 'balance') document.getElementById('balanceDisplay').innerText = `${data.balance.currency} ${data.balance.balance}`;
        if(data.msg_type === 'tick') processTick(data.tick);
        if(data.msg_type === 'buy') { isTradeActive = true; updateTxUI({ status: "Trade Active", time: new Date().toLocaleTimeString() }); }
        if(data.msg_type === 'proposal_open_contract') {
            const c = data.proposal_open_contract;
            if (c.entry_tick_display_value) document.getElementById('txEntry').innerText = c.entry_tick_display_value;
            if (c.exit_tick_display_value) document.getElementById('txTick').innerText = c.exit_tick_display_value;
            if(c?.is_sold) {
                isTradeActive = false;
                const p = parseFloat(c.profit);
                sessionProfit += p; totalTrades++;
                if(p > 0) winCount++;
                updateTxUI({ result: p > 0 ? `WIN +$${p.toFixed(2)}` : `LOSS $${p.toFixed(2)}` });
                addToHistory(c);
                updateAccountUI();
                setTimeout(() => { if(!isTradeActive) resetTxUI(); }, 5000);
            }
        }
    };
    ws.onclose = () => {
        document.getElementById('connectionStatus').classList.remove('online');
        document.getElementById('connectBtn').innerText = "CONNECT ACCOUNT";
        document.getElementById('connectBtn').classList.replace('btn-error', 'btn-primary');
        document.querySelectorAll('.sidebar .btn:not(#connectBtn)').forEach(b => b.disabled = true);
        resetSystemUI(true); 
    };
};

function processTick(tick) {
    if (!tick || !tick.quote) return;
    const digit = parseInt(tick.quote.toString().slice(-1));
    ticks.push(digit);
    if(ticks.length > 100) ticks.shift();
    tickCounter++; lastTickTime = Date.now();
    
    document.querySelectorAll('.digit-box').forEach(b => b.classList.remove('active-tick'));
    document.getElementById(`digit-${digit}`)?.classList.add('active-tick');

    const currentStats = Array(10).fill(0);
    ticks.forEach(d => currentStats[d]++);
    for(let i=0; i<=9; i++) {
        const pct = (currentStats[i] / ticks.length) * 100;
        document.getElementById(`bar-${i}`).style.height = `${pct}%`;
        document.getElementById(`pct-${i}`).innerText = `${pct.toFixed(0)}%`;
    }
    
    runAIAnalysis();
    runCoreEngines();
    
    const statusEl = document.getElementById('aiStatusDisplay');
    const ticksLeft = 10 - (tickCounter - lastTradeTick);
    if (isAiRunning) {
        if (ticksLeft > 0) { statusEl.innerText = `COOLING DOWN (${ticksLeft}t)`; statusEl.style.color = "var(--warning)"; }
        else { statusEl.innerText = "SCANNING OPPORTUNITY"; statusEl.style.color = "var(--success)"; }
    }
}

function runAIAnalysis() {
    if(ticks.length < 10) return; 
    const barrier = parseInt(document.getElementById('barrier').value);
    
    let gains = 0, losses = 0;
    for(let i = 1; i <= 14 && i < ticks.length; i++) {
        let diff = ticks[ticks.length - i] - (ticks[ticks.length - i - 1] || 0);
        if(diff >= 0) gains += diff; else losses -= diff;
    }
    const rsi = losses === 0 ? 100 : 100 - (100 / (1 + (gains / (losses || 1))));
    const recent = ticks.slice(-20);
    const mean = recent.reduce((a, b) => a + b, 0) / recent.length;
    const volatility = Math.sqrt(recent.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / recent.length);
    document.getElementById('rsiVal').innerText = rsi.toFixed(1);
    document.getElementById('volVal').innerText = volatility.toFixed(2);
    document.getElementById('trendVal').innerText = ticks.slice(-5).reduce((a,b)=>a+b)/5 > mean ? "BULL" : "BEAR";

    const poofWindow = ticks.slice(-25);
    let pOver = 0, pUnder = 0;
    poofWindow.forEach((d, idx) => { const weight = (idx + 1) / 25; if (d > barrier) pOver += weight; else if (d < barrier) pUnder += weight; });
    const decay = ((Date.now() - lastTickTime) / 1000) * 2.5; 
    poofConf = Math.max(Math.min((Math.max(pOver, pUnder) / (pOver + pUnder || 1)) * 100, 80) - decay, 0); 
    document.getElementById('poofValue').innerText = `${poofConf.toFixed(1)}%`;
    document.getElementById('poofPrediction').innerText = `Poof: ${pOver > pUnder ? "OVER" : "UNDER"} ${barrier}`;

    let rawConf = poofConf + (ticks.slice(-3).filter(d => (pOver > pUnder ? d > barrier : d < barrier)).length / 3 * 15);
    rawConf = Math.min(Math.max(rawConf - (volatility * 2), 0), 98.5);
    smoothedConf = (smoothedConf * 0.7) + (rawConf * 0.3);
    
    document.getElementById('aiConfidence').innerText = `${smoothedConf.toFixed(1)}%`;
    document.getElementById('boostFill').style.width = `${smoothedConf}%`;
    document.getElementById('aiInsight').innerText = smoothedConf > 80 ? "Cluster detected. High signal quality." : "Scanning patterns...";
}

function runCoreEngines() {
    const barrier = parseInt(document.getElementById('barrier').value);
    const dist = ticks.slice(-10).reduce((acc, d) => acc + Math.abs(d - barrier), 0) / 10;
    document.getElementById('core1Val').innerText = dist < 2 ? "HIGH" : "LOW";
    document.getElementById('core2Val').innerText = Math.abs(ticks[ticks.length-1] - (ticks[ticks.length-2]||0)).toFixed(1);
    document.getElementById('core3Val').innerText = poofConf > 60 ? "LOCKED" : "SCAN";
    document.getElementById('core4Val').innerText = (ticks.slice(-10).reduce((a,b)=>a+b)/10).toFixed(1);
}

function updateAccountUI() {
    document.getElementById('sessionProfit').innerText = `$${sessionProfit.toFixed(2)}`;
    document.getElementById('sessionProfit').style.color = sessionProfit >= 0 ? 'var(--success)' : 'var(--error)';
    if(accuracyChart) {
        accuracyChart.data.labels.push(""); accuracyChart.data.datasets[0].data.push(totalTrades > 0 ? (winCount/totalTrades)*100 : 0);
        if(accuracyChart.data.labels.length > 20) { accuracyChart.data.labels.shift(); accuracyChart.data.datasets[0].data.shift(); }
        accuracyChart.update('none');
    }
}

async function executeTrade(dir) {
    const barrier = document.getElementById('barrier').value;
    executeTradeSpecific(dir, barrier);
}

async function executeTradeSpecific(dir, barrierValue) {
    if(!ws || ws.readyState !== 1) return;
    const stake = parseFloat(document.getElementById('stake').value);
    safeSend({
        buy: 1, price: stake,
        parameters: { 
            amount: stake, basis: 'stake', contract_type: dir === 'over' ? 'DIGITOVER' : 'DIGITUNDER', 
            currency: 'USD', duration: parseInt(document.getElementById('duration').value), 
            duration_unit: 't', symbol: document.getElementById('market').value, barrier: barrierValue.toString()
        }
    });
}

document.getElementById('buyOver').onclick = () => executeTrade('over');
document.getElementById('buyUnder').onclick = () => executeTrade('under');
document.getElementById('aiBtn').onclick = () => {
    isAiRunning = !isAiRunning;
    document.getElementById('aiBtn').innerText = isAiRunning ? "STOP AI ENGINE" : "START AI ENGINE";
    document.getElementById('aiBtn').classList.toggle('btn-omega', !isAiRunning);
    document.getElementById('aiBtn').classList.toggle('btn-error', isAiRunning);
    if(isAiRunning) autoLoop();
};

async function autoLoop() {
    if(!isAiRunning) return;
    const cdLimit = 10;
    
    // Logic to respect AI Mode
    const mode = document.getElementById('aiMode').value;
    let threshold = 85; // Default for Adaptive
    if (mode === 'aggressive') threshold = 78;
    if (mode === 'conservative') threshold = 91;

    if(smoothedConf >= threshold && !isTradeActive && (tickCounter - lastTradeTick) >= cdLimit) {
        const dir = document.getElementById('poofPrediction').innerText.includes("OVER") ? "over" : "under";
        lastTradeTick = tickCounter; 
        const bulk = parseInt(document.getElementById('bulk').value) || 1;
        for(let i=0; i<bulk; i++) { executeTrade(dir); await new Promise(r => setTimeout(r, 200)); }
    }
    setTimeout(() => { if(isAiRunning) autoLoop(); }, 200);
}
document.getElementById('clearHistory').onclick = () => { document.getElementById('historyList').innerHTML = ''; };
</script>
</body>
</html>
